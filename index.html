<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Deteksi v5.2 (Perbaikan Teks & Filter)</title>
    <!-- Library AI -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; font-family: 'Inter', sans-serif; }
        #video { transform: scaleX(-1); object-fit: cover; }
        #canvas { position: absolute; top: 0; left: 0; image-rendering: pixelated; }
        .loader-modal { backdrop-filter: blur(10px); transition: opacity 0.5s ease-out; }
        
        /* Efek UI Keren */
        .btn-active { 
            background-color: #14b8a6 !important; 
            color: white !important; 
            box-shadow: 0 0 15px rgba(20, 184, 166, 0.7);
        }
        .toggle-checkbox:checked { right: 0; border-color: #14b8a6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #14b8a6; box-shadow: 0 0 10px rgba(20, 184, 166, 0.7); }
        .status-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            50% { opacity: .7; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="loader" class="loader-modal fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 bg-opacity-80">
        <div class="w-16 h-16 border-4 border-teal-400 border-t-transparent rounded-full animate-spin"></div>
        <p id="loader-text" class="mt-4 text-lg text-center w-3/4">Memuat model AI...</p>
    </div>

    <div class="relative w-screen h-screen">
        <video id="video" class="w-full h-full" playsinline autoplay muted></video>
        <canvas id="canvas" class="w-full h-full"></canvas>
    </div>

    <div id="ui-container" class="fixed top-0 left-0 w-full p-4 z-10 bg-gradient-to-b from-black/70 to-transparent">
        <div class="max-w-4xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
             <div class="flex items-center bg-gray-800 rounded-lg p-1 space-x-1">
                <button id="mode-object" class="mode-btn px-3 py-2 text-sm font-medium rounded-md btn-active">Deteksi Objek</button>
             </div>
            
            <div class="flex items-center space-x-3 bg-gray-800 rounded-lg p-2">
                <span class="font-medium text-sm text-gray-300">Filter Suhu</span>
                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="thermal-toggle" id="thermal-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="thermal-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                </div>
            </div>

            <div id="status-box" class="text-center bg-gray-800/80 p-2 rounded-lg min-w-[200px]">
                <p id="status" class="text-base font-semibold text-teal-300">Menunggu kamera...</p>
                <p id="calibration-info" class="text-xs text-gray-400">Kalibrasi: Belum ada.</p>
            </div>
        </div>
    </div>
    
    <script>
        // --- Deklarasi Elemen & Variabel ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const loader = document.getElementById('loader');
        const statusEl = document.getElementById('status');
        const calibrationInfoEl = document.getElementById('calibration-info');
        const thermalToggle = document.getElementById('thermal-toggle');
        
        const DETECTION_INTERVAL_MS = 300;
        const PROCESSING_CANVAS_WIDTH = 160;

        const processingCanvas = document.createElement('canvas');
        const processingCtx = processingCanvas.getContext('2d', { willReadFrequently: true });
        
        let objectModel = null;
        let lastObjectPredictions = [];
        let isThermalModeActive = false;
        let pixelsPerCm = null;
        
        const AVG_FACE_WIDTH_CM = 14.0;
        const animalClasses = ['bird', 'cat', 'dog', 'horse', 'sheep', 'cow', 'elephant', 'bear', 'zebra', 'giraffe'];
        
        function getCategory(className) {
            if (className === 'person') return { name: 'Human', color: '#14b8a6' };
            if (animalClasses.includes(className)) return { name: 'Animal', color: '#f59e0b' };
            return { name: 'Equipment', color: '#6366f1' };
        }

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'user' }, audio: false });
            video.srcObject = stream;
            return new Promise(resolve => { video.onloadedmetadata = () => resolve(video); });
        }
        
        function renderLoop() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Cerminkan konteks canvas agar semua yang digambar terbalik
            ctx.save();
            ctx.scale(-1, 1);
            ctx.translate(-canvas.width, 0);

            if (isThermalModeActive) {
                const pHeight = Math.round(PROCESSING_CANVAS_WIDTH * (canvas.height / canvas.width));
                processingCanvas.width = PROCESSING_CANVAS_WIDTH; processingCanvas.height = pHeight;
                processingCtx.drawImage(video, 0, 0, PROCESSING_CANVAS_WIDTH, pHeight);
                const imageData = processingCtx.getImageData(0, 0, PROCESSING_CANVAS_WIDTH, pHeight);
                applyThermalFilter(imageData);
                processingCtx.putImageData(imageData, 0, 0);
                ctx.drawImage(processingCanvas, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            }
            
            ctx.restore(); // Kembalikan konteks ke normal (tidak terbalik)

            // Gambar kotak dan TULISAN di atas konteks normal
            drawObjectPredictions(lastObjectPredictions);
            
            requestAnimationFrame(renderLoop);
        }

        async function runDetectionLoop() {
            if (!objectModel || video.readyState < 2 || video.paused) return;
            
            statusEl.textContent = 'Mendeteksi...';
            statusEl.classList.add('status-pulse');
            const predictions = await objectModel.detect(video);
            lastObjectPredictions = predictions;
            
            const personPrediction = predictions.find(p => p.class === 'person');
            if (personPrediction) {
                pixelsPerCm = personPrediction.bbox[2] / AVG_FACE_WIDTH_CM;
                calibrationInfoEl.textContent = `Kalibrasi OK! 1cm â‰ˆ ${pixelsPerCm.toFixed(2)}px`;
            }
        }

        function drawObjectPredictions(predictions) {
            predictions.forEach(p => {
                // Koreksi koordinat X karena video dicerminkan tapi canvas tidak
                const mirroredX = canvas.width - p.bbox[0] - p.bbox[2];
                const [y, width, height] = [p.bbox[1], p.bbox[2], p.bbox[3]];
                
                const category = getCategory(p.class);
                ctx.strokeStyle = category.color;
                ctx.lineWidth = 4;
                ctx.strokeRect(mirroredX, y, width, height);

                const text = `${category.name} (${Math.round(p.score * 100)}%)`;
                ctx.font = '16px Inter, sans-serif';
                const textWidth = ctx.measureText(text).width;

                ctx.fillStyle = category.color;
                ctx.fillRect(mirroredX, y - 28, textWidth + 10, 28);
                ctx.fillStyle = '#ffffff';
                ctx.fillText(text, mirroredX + 5, y - 8);

                if (pixelsPerCm) {
                    const widthCm = (width / pixelsPerCm).toFixed(1);
                    const heightCm = (height / pixelsPerCm).toFixed(1);
                    const mText = `Est: ${widthCm}cm x ${heightCm}cm`;
                    const mWidth = ctx.measureText(mText).width;
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.fillRect(mirroredX, y + height, mWidth + 10, 24);
                    ctx.fillStyle = '#ffffff';
                    ctx.fillText(mText, mirroredX + 5, y + height + 17);
                }
            });
        }
        
        function applyThermalFilter(imageData) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                const thermalColor = mapBrightnessToThermalColor(brightness);
                data[i] = thermalColor.r; data[i+1] = thermalColor.g; data[i+2] = thermalColor.b;
            }
        }
        function mapBrightnessToThermalColor(brightness) {
            const t = brightness / 255;
            let r=0, g=0, b=0;
            if (t < 0.25) { r = 0; g = t * 4 * 255; b = 255; }
            else if (t < 0.5) { r = (t - 0.25) * 4 * 255; g = 255; b = 255 - r; }
            else if (t < 0.75) { r = 255; g = 255 - (t - 0.5) * 4 * 255; b = 0; }
            else { r = 255; g = (t - 0.75) * 4 * 255; b = g; }
            return { r, g, b };
        }

        thermalToggle.addEventListener('change', (e) => { isThermalModeActive = e.target.checked; });
        
        async function main() {
            objectModel = await cocoSsd.load();
            await setupCamera();
            loader.style.opacity = 0;
            setTimeout(() => loader.style.display = 'none', 500);
            requestAnimationFrame(renderLoop);
            setInterval(runDetectionLoop, DETECTION_INTERVAL_MS);
        }
        main();
    </script>
</body>
</html>

